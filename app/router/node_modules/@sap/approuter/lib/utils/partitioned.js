'use strict';

module.exports = (config, middleware) => config ? (req, res, next) => {
  const re = /;\s*Partitioned\s*(;|$)/i;
  const partitioned = ' Partitioned';
  const userAgent = req.headers['user-agent'] || '';
  const _setHeader = res.setHeader;
  if (userAgent.match(config.supportedPartitionAgents) && !userAgent.match(config.unsupportedPartitionAgents)) {
    res.setHeader = function (key, val) {
      return _setHeader.call(res, key, key && key.toLowerCase() === 'set-cookie' && Array.isArray(val) ?
        val.map(v => v.match(re) ? v : v + (v.endsWith(';') ? partitioned : ';' + partitioned)) :
        val
      );
    };
  }

  return middleware(req, res, next);
} : middleware;
